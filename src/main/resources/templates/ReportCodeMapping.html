<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BRF Report Mapping</title>
    <!-- CSS Includes -->
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/4.3.1/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/webjars/font-awesome/5.9.0/css/all.min.css}">
    <link rel="stylesheet" th:href="@{/webjars/datatables/1.10.19/css/jquery.dataTables.min.css}">
    <link rel="stylesheet" th:href="@{/css/select2.min.css}">
    <link rel="stylesheet" th:href="@{/css/CustomButton.css}" />
    <style>
        body { font-family: 'Verdana', sans-serif; }
        .btn-primary { background-color: #E77400; border-color: #0c0c0c; }
        .table-container { width: 100%; overflow-x: auto; }
        .left-arrow-circle { width: 35px; height: 35px; border-radius: 50%; background-color: white; display: flex; align-items: center; justify-content: center; margin-right: 10px; transition: background-color 0.3s, transform 0.2s; border: 1px solid #ccc; }
        .left-arrow-circle:hover { background-color: rgb(107, 122, 143); cursor: pointer; transform: scale(1.05); }
        .left-arrow-circle:hover i { color: white; }
        .custom-tab-btn { background-color: #f0f0f0; border: 1px solid #ccc; padding: 8px 15px; cursor: pointer; border-radius: 5px 5px 0 0; margin-right: 5px; font-weight: bold; color: #555; }
        .custom-tab-btn.active { background-color: #376275; color: white; border-color: #376275; border-bottom: none; }
        .tab-content-section { border: 1px solid #ccc; border-top: none; padding: 20px; background-color: white; border-radius: 0 0 5px 5px; }
        .modal-header { background-color: #376275; color: white; }
        .modal-body label { font-weight: bold; }
        .action-icon { font-size: 16px; cursor: pointer; color: #007bff; }
        .action-icon:hover { transform: scale(1.2); color: #0056b3; }
        /* Style for Select2 dropdowns */
        .select2-container .select2-selection--single { height: calc(1.5em + .5rem + 2px); }
        .select2-container { width: 100% !important; }
        
        /* Style for the GL Sub Head checkbox container */
        #glSubHeadContainer {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            padding: .375rem .75rem;
            border-radius: .25rem;
            background-color: #fff;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row">
            <div th:insert="HeaderMenu :: header"></div>
        </div>

        <!-- Main Content -->
        <div class="col-sm-12">
            <div th:if="${formmode}=='list'">
                <div class="card" style="margin-left:10px;margin-right: 10px;">
                    <div class="card-header" style="background-color: #376275; display: flex; align-items: center; padding: 10px 20px;">
                        <div style="display: flex; align-items: center;" onclick="back();">
                            <div class="left-arrow-circle"><i class="fa fa-arrow-left"></i></div>
                            <h5 th:text="${menu}" style="font-family: verdana; font-size: 20px; font-weight: bold; color: white; margin: 0 0 0 10px;"></h5>
                        </div>
                    </div>

                    <div class="row align-items-center" style="padding: 1rem 20px 0 20px;">
                        <label for="ReportCode" class="col-sm-1 col-form-label pl-0" style="font-weight: bold; color: #495057;">Report Code</label>
                        <div class="col-sm-2">
                            <select id="ReportCode" class="form-control form-control-sm" name="ReportCode" autocomplete="off" required onchange="handleReportCodeChange();">
                                <option value="">Select</option>
                                <option th:each="code : ${RptCodes}" th:value="${code}" th:text="${code}"></option>
                            </select>
                        </div>
                        <div class="col-sm-1"></div>
                        <label for="ReportName" class="col-sm-2 col-form-label pl-0" style="font-weight: bold; color: #495057;">Report Name</label>
                        <div class="col-sm-3"><input type="text" id="ReportName" name="ReportName" class="form-control form-control-sm" autocomplete="off" readonly></div>
                    </div>

                    <div id="tabsSection" style="display:none; padding: 10px;">
                        <div class="text-center mb-3">
                            <button class="custom-tab-btn active" id="tabReportList" onclick="switchTab('reportList')">Report Code List</button>
                            <button class="custom-tab-btn" id="tabMapping" onclick="switchTab('mapping')">Mapping Maintenance</button>
                            <button class="custom-tab-btn" id="tabMappedAccounts" onclick="switchTab('mappedAccounts')">Mapped Accounts</button>
                            <button class="custom-tab-btn" id="tabUnmappedAccounts" onclick="switchTab('unmappedAccounts')">Unmapped Accounts</button>
                        </div>

                        <!-- Report Code List Section -->
                        <div id="reportList" class="tab-content-section">
                            <div class="table-container" style="max-height: 520px; overflow-y: auto;">
                                <table class="table table-striped table-bordered table-hover" id="usertable">
                                    <thead class="thead-light">
                                        <tr>
                                            <th>SRL_NO</th>
                                            <th>FIELD DESCRIPTION</th>
                                            <th>Report Label</th>
                                            <th>Header</th>
                                            <th>Remarks</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Mapping Maintenance Section -->
                        <div id="mapping" class="tab-content-section" style="display:none;">
                            <form action="#" th:object="${item}" method="post" autocomplete="off" id="bfdbitem">
                                <div class="container-fluid">
                                    <div class="row mb-3 align-items-center">
                                        <label class="col-lg-1 col-form-label">Row Label</label>
                                        <div class="col-lg-3"><select id="rowLabel" name="rowLabel" class="form-control form-control-sm"><option value="">Select Row Label</option></select></div>
                                        <label class="col-lg-1 col-form-label">Column Label</label>
                                        <div class="col-lg-3"><select id="columnLabel" name="columnLabel" class="form-control form-control-sm"><option value="">Select Column Label</option></select></div>
                                        <label class="col-lg-1 col-form-label">Description</label>
                                        <div class="col-lg-3"><input type="text" id="fieldDescription" name="fieldDescription" class="form-control form-control-sm" readonly></div>
                                    </div>
                                    <div class="row mb-3 align-items-center">
                                        <label class="col-lg-1 col-form-label">Source</label>
                                        <div class="col-lg-2">
                                            <select id="source" name="source" class="form-control form-control-sm" onchange="handleSourceChange();">
                                                <option value="">Select Source</option>
                                                <option value="TREASURY">TREASURY</option>
                                                <option value="BANKING">BANKING</option>
                                            </select>
                                        </div>
                                        <label class="col-lg-1 col-form-label">GL Head</label>
                                        <div class="col-lg-3"><select id="glHead" name="glHead" class="form-control form-control-sm" onchange="loadGlSubHeads();"><option value="">Select GL Head</option></select></div>
                                        <label class="col-lg-1 col-form-label align-self-start mt-2">GL Sub Head</label>
                                        <div class="col-lg-4"><div id="glSubHeadContainer"></div></div>
                                    </div>
                                    <div class="row mb-3"><div class="col-sm-12 text-center"><button type="button" class="btn btn-info btn-sm" onclick="fetchAccountDetails();">Show Accounts</button></div></div>
                                    <div id="accountsTableContainer" class="mt-4" style="display:none;">
                                        <h5>Accounts</h5>
                                        <div class="table-container mt-2" style="max-height: 300px; overflow-y: auto;">
                                            <table class="table table-striped table-bordered table-hover" id="gl_accounts_table">
                                                <thead class="thead-light">
                                                    <tr>
                                                        <th style="width: 5%;"><input type="checkbox" id="selectAllAccounts"></th>
                                                        <th>GL Head</th><th>GL Sub Head Code</th><th>Account ID (BACID)</th><th>Account Description</th><th>Currency</th><th>Account Balance (LC)</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <div class="card-footer text-center mt-3">
                                <button type="button" class="btn btn-secondary" id="btnCancel" onclick="clearMappingForm();">Cancel</button>
                                <button type="button" class="btn btn-primary" id="btnSubmit" onclick="submitForm();" title="Submit">Submit</button>
                            </div>
                        </div>

                        <!-- Mapped Accounts Section -->
                        <div id="mappedAccounts" class="tab-content-section" style="display:none;">
                            <div class="d-flex justify-content-end mb-2"><button class="btn btn-success btn-sm" onclick="downloadMappedExcel()"><i class="fas fa-file-excel"></i> Download Excel</button></div>
                            <div class="table-container" style="max-height: 520px; overflow-y: auto;">
                                <table class="table table-striped table-bordered table-hover" id="mapped_accounts_table">
                                    <thead class="thead-light">
                                        <tr>
                                            <th>Customer Id</th><th>Account No</th><th>Name of Account</th><th>Report Code</th><th>Report Label</th><th>Scheme Code</th><th>GLSH Code</th><th>Criteria 1</th><th>Criteria 2</th><th>Criteria 3</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Unmapped Accounts Section -->
                        <div id="unmappedAccounts" class="tab-content-section" style="display:none;">
                            <div class="d-flex justify-content-end mb-2"><button class="btn btn-success btn-sm" onclick="downloadUnmappedExcel()"><i class="fas fa-file-excel"></i> Download Excel</button></div>
                            <div class="table-container" style="max-height: 520px; overflow-y: auto;">
                                <table class="table table-striped table-bordered table-hover" id="unmapped_accounts_table">
                                    <thead class="thead-light">
                                        <tr>
                                            <th>Actions</th><th>Customer Id</th><th>Account No</th><th>Name of Account</th><th>Report Code</th><th>Report Label</th><th>Scheme Code</th><th>GLSH Code</th><th>Criteria 1</th><th>Criteria 2</th><th>Criteria 3</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Modal for Unmapped Accounts -->
    <div class="modal fade" id="editAccountModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Account Mapping</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <!-- Your form fields for editing would go here -->
                    <p>Modal for editing unmapped accounts. Account ID: <strong id="modal-account-id"></strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SCRIPT SECTION -->
    <script th:src="@{/webjars/jquery/3.4.1/jquery.min.js}"></script>
    <script th:src="@{/webjars/popper.js/1.14.7/umd/popper.min.js}"></script>
    <script th:src="@{/webjars/bootstrap/4.3.1/js/bootstrap.min.js}"></script>
    <script th:src="@{/webjars/datatables/1.10.19/js/jquery.dataTables.min.js}"></script>
    <script th:src="@{/js/select2.min.js}"></script>

    <script th:inline="javascript">
        $(document).ready(function() {
            $('#glHead').select2({ placeholder: "Select GL Head", allowClear: true });
            $('#selectAllAccounts').on('click', function() {
                $('#gl_accounts_table tbody tr:visible .account-checkbox').prop('checked', this.checked);
            });
            $('#gl_accounts_table tbody').on('click', '.account-checkbox', function() {
                if (!this.checked) { $('#selectAllAccounts').prop('checked', false); }
            });
        });

        function back() { window.history.back(); }

        function handleReportCodeChange() {
            const reportCode = $('#ReportCode').val();
            if (reportCode) {
                $("#tabsSection").show();
                fetchRptName(reportCode);
                loadReportData(reportCode);
                loadColumnData(reportCode);
                switchTab('reportList');
            } else {
                $("#tabsSection").hide();
                $('#ReportName').val('');
                $('#rowLabel, #columnLabel').empty().append('<option value="">Select</option>');
            }
        }

        function switchTab(tabId) {
            $('.tab-content-section').hide();
            $('.custom-tab-btn').removeClass('active');
            $('#' + tabId).show();
            $('#tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1)).addClass('active');
            if (tabId === 'mappedAccounts') loadMappedAccountsData();
            else if (tabId === 'unmappedAccounts') loadUnmappedAccountsData();
        }

        function handleSourceChange() {
            const source = $("#source").val();
            $("#accountsTableContainer").hide();
            $('#glHead').empty().append('<option value=""></option>').trigger('change');
            $('#glSubHeadContainer').empty();
            $('#gl_accounts_table tbody').empty();
            if (source) {
                const dataType = (source === "TREASURY") ? "TREASURY" : "GL";
                loadGlHeads(dataType);
            }
        }

        function loadGlHeads(dataType) {
            $.ajax({
                url: `/BRF/getGlHeads?dataType=${dataType}`, type: 'GET',
                success: function(data) {
                    const glHeadSelect = $('#glHead').empty().append('<option value=""></option>');
                    if (data && data.length > 0) {
                        data.forEach(glHead => glHeadSelect.append(`<option value="${glHead}">${glHead}</option>`));
                    }
                    glHeadSelect.trigger('change');
                }, error: () => alert('Error fetching GL Heads.')
            });
        }

        function loadGlSubHeads() {
            const glHead = $('#glHead').val();
            const subHeadContainer = $('#glSubHeadContainer').empty();
            $('#gl_accounts_table tbody').empty();
            $('#accountsTableContainer').hide();
            if (!glHead) return;
            $.ajax({
                url: `/BRF/getGlSubHeads?glHead=${glHead}`, type: 'GET',
                success: function(data) {
                    if (data && data.length > 0) {
                        data.forEach(subHead => {
                            const checkboxId = `subhead-${subHead.replace(/[^a-zA-Z0-9]/g, "")}`;
                            subHeadContainer.append(`<div class="form-check"><input class="form-check-input" type="checkbox" name="glSubHead" value="${subHead}" id="${checkboxId}"><label class="form-check-label" for="${checkboxId}">${subHead}</label></div>`);
                        });
                    } else { subHeadContainer.html('<span class="text-muted">No Sub-Heads found.</span>'); }
                }, error: () => alert('Error fetching GL Sub Heads.')
            });
        }

        function fetchAccountDetails() {
            const selectedSubHeads = $('input[name="glSubHead"]:checked').map((_, el) => el.value).get();
            if (selectedSubHeads.length === 0) { alert('Please select at least one GL Sub Head.'); return; }
            $('#selectAllAccounts').prop('checked', false);
            $.ajax({
                url: '/BRF/getAccountDetails', type: 'POST', contentType: 'application/json',
                data: JSON.stringify(selectedSubHeads),
                success: function(data) {
                    const tableBody = $('#gl_accounts_table tbody').empty();
                    if (data && data.length > 0) {
                        $('#accountsTableContainer').show();
                        data.forEach(item => {
                            tableBody.append(`<tr>
                                <td><input type="checkbox" class="account-checkbox" value="${item.accountIdBacid}"></td>
                                <td>${item.glHead || ''}</td><td>${item.glSubHeadCode || ''}</td>
                                <td>${item.accountIdBacid || ''}</td><td>${item.accountDescription || ''}</td>
                                <td>${item.currency || ''}</td><td>${item.acctBalanceLc != null ? item.acctBalanceLc.toFixed(2) : '0.00'}</td>
                            </tr>`);
                        });
                    } else {
                        $('#accountsTableContainer').hide();
                        alert('No accounts found for the selected criteria.');
                    }
                }, error: () => alert('Error fetching account details.')
            });
        }

        function clearMappingForm() {
            $('#bfdbitem')[0].reset();
            $('#fieldDescription').val('');
            $('#glHead').val(null).trigger('change');
            handleSourceChange();
        }

        function submitForm() {
            const checkedRows = $('#gl_accounts_table tbody .account-checkbox:checked');
            if (checkedRows.length === 0) { alert('No accounts selected to map.'); return; }
            const reportCode = $('#ReportCode').val();
            const rowLabel = $('#rowLabel').val();
            const columnLabel = $('#columnLabel').val();
            if (!reportCode || !rowLabel || !columnLabel) { alert('Please ensure Report Code, Row Label, and Column Label are selected.'); return; }
            const mappings = [];
            checkedRows.each(function() {
                const row = $(this).closest('tr');
                mappings.push({
                    reportCode: reportCode, report_desc: $('#ReportName').val(),
                    rowLabel: rowLabel, columnLabel: columnLabel,
                    gl_head: row.find('td:eq(1)').text(), gl_subhead_code: row.find('td:eq(2)').text(),
                    account_id_bacid: row.find('td:eq(3)').text(), account_description: row.find('td:eq(4)').text(),
                    currency: row.find('td:eq(5)').text(), data_type: ($("#source").val() === 'TREASURY') ? 'TREASURY' : 'GL'
                });
            });
            $.ajax({
                url: '/BRF/saveBulkMapping', type: 'POST', contentType: 'application/json',
                data: JSON.stringify(mappings),
                success: (response) => { alert(response); clearMappingForm(); },
                error: (xhr) => alert('Error saving mapping: ' + xhr.responseText)
            });
        }
        
        function fetchRptName(rptCode) {
             $.ajax({ url: `/BRF/getRptName?rptCode=${rptCode}`, type: 'GET', success: r => $('#ReportName').val(r), error: () => $('#ReportName').val('Error') });
        }

        function loadReportData(reportCode) {
             $.ajax({
                url: `/BRF/getReportDataByCode?reportCode=${reportCode}`, type: 'GET',
                success: data => {
                    const tbody = $('#usertable tbody').empty();
                    const rowSelect = $('#rowLabel').empty().append('<option value="">Select Row Label</option>');
                    const labelMap = {};
                    if (!data || data.length === 0) { tbody.append('<tr><td colspan="5">No data available.</td></tr>'); return; }
                    data.forEach(item => {
                        tbody.append(`<tr><td>${item.srlNo||''}</td><td>${item.fieldDescription||''}</td><td>${item.reportLabel||''}</td><td>${item.header||''}</td><td>${item.remarks||''}</td></tr>`);
                        if (item.header !== 'Y' && item.reportLabel) {
                            rowSelect.append(`<option value="${item.reportLabel}">${item.reportLabel} - ${item.fieldDescription}</option>`);
                            labelMap[item.reportLabel] = item.fieldDescription || '';
                        }
                    });
                    rowSelect.off('change').on('change', function() { $('#fieldDescription').val(labelMap[this.value] || ''); });
                }, error: () => $('#usertable tbody').empty().append('<tr><td colspan="5">Error loading data.</td></tr>')
            });
        }

        function loadColumnData(reportCode) {
             $.ajax({
                url: `/BRF/getReportColumnsByCode?reportCode=${reportCode}`, type: 'GET',
                success: data => {
                    const colSelect = $('#columnLabel').empty().append('<option value="">Select Column Label</option>');
                    if (data && data.length > 0) { data.forEach(item => colSelect.append(`<option value="${item.columnId}">${item.columnId} - ${item.columnName}</option>`)); }
                }, error: () => $('#columnLabel').empty().append('<option value="">Error</option>')
            });
        }

        function loadMappedAccountsData() {
            const reportCode = $('#ReportCode').val();
            if (!reportCode) return;
            $.ajax({
                url: `/BRF/Reports/mapped_accounts/${reportCode}`, type: 'GET',
                success: data => populateAccountTable('#mapped_accounts_table', data, false),
                error: () => $('#mapped_accounts_table tbody').html(`<tr><td colspan="10" class="text-center">Error loading data.</td></tr>`)
            });
        }

        function loadUnmappedAccountsData() {
            const reportCode = $('#ReportCode').val();
            if (!reportCode) return;
            $.ajax({
                url: `/BRF/Reports/unmapped_accounts/${reportCode}`, type: 'GET',
                success: data => populateAccountTable('#unmapped_accounts_table', data, true),
                error: () => $('#unmapped_accounts_table tbody').html(`<tr><td colspan="11" class="text-center">Error loading data.</td></tr>`)
            });
        }

        function populateAccountTable(tableId, data, showActions) {
            const tbody = $(tableId + ' tbody').empty();
            const colspan = showActions ? 11 : 10;
            if (!data || data.length === 0) { tbody.append(`<tr><td colspan="${colspan}" class="text-center">No accounts found.</td></tr>`); return; }
            data.forEach(item => {
                let rowHtml = `<tr>`;
                if (showActions) { rowHtml += `<td class="text-center"><i class="fas fa-edit action-icon" onclick="openEditModal('${item.foracid}')" title="Edit Mapping"></i></td>`; }
                rowHtml += `<td>${item.cust_id||''}</td><td>${item.foracid||''}</td><td>${item.acct_name||''}</td><td>${item.report_name_1||''}</td><td>${item.report_label_1||''}</td>
                            <td>${item.schm_code||''}</td><td>${item.glsh_code||''}</td><td>${item.report_addl_criteria_1||''}</td><td>${item.report_addl_criteria_2||''}</td><td>${item.report_addl_criteria_3||''}</td></tr>`;
                tbody.append(rowHtml);
            });
        }

        function openEditModal(accountId) {
            $('#modal-account-id').text(accountId);
            $('#editAccountModal').modal('show');
        }

        function downloadMappedExcel() {
            const reportCode = $('#ReportCode').val();
            if (reportCode) window.location.href = `/BRF/Reports/mapped_accounts/download/${reportCode}`;
        }

        function downloadUnmappedExcel() {
            const reportCode = $('#ReportCode').val();
            if (reportCode) window.location.href = `/BRF/Reports/unmapped_accounts/download/${reportCode}`;
        }
    </script>
</body>
</html>