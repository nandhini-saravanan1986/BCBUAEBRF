<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />

	<!-- CSS (Bootstrap, FontAwesome, jQuery UI, DataTables) -->
	<link rel="stylesheet" type="text/css" href="/webjars/bootstrap/4.3.1/css/bootstrap.min.css"
		th:href="@{/webjars/bootstrap/4.3.1/css/bootstrap.min.css}" />

	<link rel="stylesheet" type="text/css" href="/webjars/font-awesome/5.9.0/css/all.min.css"
		th:href="@{/webjars/font-awesome/5.9.0/css/all.min.css}" />

	<link rel="stylesheet" type="text/css" href="/webjars/jquery-ui/1.12.1/jquery-ui.min.css"
		th:href="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.css}" />

	<link rel="stylesheet" type="text/css" href="/webjars/datatables/1.10.19/css/jquery.dataTables.min.css"
		th:href="@{/webjars/datatables/1.10.19/css/jquery.dataTables.min.css}" />

	<link rel="stylesheet" th:href="@{/css/CustomButton.css}" />

	
	<!-- Favicon -->
	<link rel="shortcut icon" type="image/x-icon" th:href="@{/favicon.ico}" />
	<link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}" />

	<!-- JavaScript: jQuery must come first -->
	<script src="/webjars/jquery/3.4.1/jquery.min.js" th:src="@{/webjars/jquery/3.4.1/jquery.min.js}"></script>

	<script src="/webjars/jquery-ui/1.12.1/jquery-ui.min.js"
		th:src="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.js}"></script>

	<script src="/webjars/popper.js/1.14.7/umd/popper.min.js"
		th:src="@{/webjars/popper.js/1.14.7/umd/popper.min.js}"></script>

	<script src="/webjars/bootstrap/4.3.1/js/bootstrap.min.js"
		th:src="@{/webjars/bootstrap/4.3.1/js/bootstrap.min.js}"></script>

	<script src="/webjars/jquery-validation/1.19.0/jquery.validate.min.js"
		th:src="@{/webjars/jquery-validation/1.19.0/jquery.validate.min.js}"></script>

	<script src="/webjars/jquery-form/4.2.2/jquery.form.min.js"
		th:src="@{/webjars/jquery-form/4.2.2/jquery.form.min.js}"></script>

	<script src="/webjars/datatables/1.10.19/js/jquery.dataTables.min.js"
		th:src="@{/webjars/datatables/1.10.19/js/jquery.dataTables.min.js}"></script>

	<script src="/webjars/datatables/1.10.19/js/dataTables.bootstrap4.min.js"
		th:src="@{/webjars/datatables/1.10.19/js/dataTables.bootstrap4.min.js}"></script>

	<style>
		/* Custom Styles for a cleaner look */
		body {
			background-color: #f8f9fa;
		}

		.card {
			border: none;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
		}

		.card-header {
			font-family: verdana, sans-serif;
			font-weight: bold;
			color: white;
			border-bottom: none;
		}

		.card-footer {
			background-color: #f1f3f5;
			border-top: 1px solid #dee2e6;
			padding: 15px;
			display: flex;
			justify-content: center;
			gap: 15px;
		}

		.error {
			color: #dc3545 !important;
		}

		/* Table Action Icons */
		.action-icon {
			font-size: 18px;
			cursor: pointer;
			margin-right: 12px;
			transition: transform 0.2s, color 0.2s;
		}

		.action-icon:hover {
			transform: scale(1.2);
		}

		.action-icon.view {
			color: #28a745;
		}

		.action-icon.modify {
			color: #007bff;
		}

		.action-icon.delete {
			color: #dc3545;
		}

		/* Back Arrow Button in Header */
		.left-arrow-circle {
			width: 35px;
			height: 35px;
			border-radius: 50%;
			background-color: white;
			display: flex;
			align-items: center;
			justify-content: center;
			margin-right: 15px;
			transition: all 0.3s ease;
		}

		.left-arrow-circle i {
			color: #495057;
		}

		.left-arrow-circle:hover {
			background-color: #e9ecef;
			cursor: pointer;
			transform: scale(1.05);
		}
	</style>

</head>
<title>BRF - Base Mapping Parameter</title>

<body>
	<div class="container-fluid">
		<div class="row">
			<div th:insert="HeaderMenu :: header"></div>

			<div class="col-sm-12">
				<!-- LIST MODE -->
				<div th:if="${formmode}=='list'" style="padding: 0 10px;">
					<div class="card my-3">
						<div class="card-header"
							style="background-color: #376275; display: flex; align-items: center; justify-content: space-between;">
							<div style="display: flex; align-items: center;">
								<div class="left-arrow-circle" onclick="window.history.back();"><i
										class="fa fa-arrow-left"></i></div>
								<h5 th:text="${menu}" style="font-size: 20px; margin: 0;"></h5>
							</div>
							<button type="button" class="custom-tab-btn" onclick="add_new_record();">Add New</button>
						</div>

						<div class="card-body">
							<div class="table-container" style="max-height: 650px; overflow-y: auto;">
								<table class="table table-striped table-bordered table-hover" id="usertable">
									<thead class="thead-light">
										<tr>
											<th>Gl Head</th>
											<th>Gl Sub Head Code</th>
											<th>Account ID/Bacid</th>
											<th>Account Description</th>
											<th>Currency</th>
											<th>Data Type</th>
											<th style="width: 12%; text-align: center;">Action</th>
										</tr>
									</thead>
									<tbody>
										<tr th:each="data : ${Basemappingparameter}">
											<td th:text="${data.gl_head}"></td>
											<td th:text="${data.gl_subhead_code}"></td>
											<td th:text="${data.account_id_bacid}"></td>
											<td th:text="${data.account_description}"></td>
											<td th:text="${data.currency}"></td>
											<td th:text="${data.data_type}"></td>
											<td class="text-center">
												<i class="fa fa-eye action-icon view" title="View"
													th:attr="data-id=${data.account_id_bacid}"
													onclick="view_btn_submit(this)"></i>
												<i class="fa fa-edit action-icon modify" title="Modify"
													th:attr="data-id=${data.account_id_bacid}"
													onclick="edit_btn_submit(this)"></i>
												<i class="fa fa-trash action-icon delete" title="Delete"
													th:attr="data-id=${data.account_id_bacid}"
													onclick="delete_btn_submit(this)"></i>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
						<!-- Footer removed as per request -->
					</div>
				</div>

				<!-- ADD MODE -->
				<div th:if="${formmode}=='add'" style="padding: 0 10px;">
					<div class="card my-3">
						<div class="card-header" style="background-color: #376275; display: flex; align-items: center;">
							<div class="left-arrow-circle" onclick="list();"><i class="fa fa-arrow-left"></i></div>
							<h5 th:text="${menu}" style="font-size: 20px; margin: 0;"></h5>
						</div>

						<form id="addForm" method="post">
							<div class="card-body" style="max-height: 600px; overflow-y: auto;">
								<!-- Form Rows -->
								<div class="form-group row">
									<label for="gl_head" class="col-sm-2 col-form-label">Gl Head</label>
									<div class="col-sm-4"><input type="text" id="gl_head" name="gl_head"
											class="form-control" required /></div>
									<label for="gl_subhead_code" class="col-sm-2 col-form-label">Gl Sub Head
										Code</label>
									<div class="col-sm-4"><input type="text" id="gl_subhead_code" name="gl_subhead_code"
											class="form-control" required /></div>
								</div>
								<div class="form-group row">
									<label for="account_id_bacid" class="col-sm-2 col-form-label">Account
										ID/Bacid</label>
									<div class="col-sm-4"><input type="text" id="account_id_bacid"
											name="account_id_bacid" class="form-control" required /></div>
									<label for="account_description" class="col-sm-2 col-form-label">Account
										Description</label>
									<div class="col-sm-4"><input type="text" id="account_description"
											name="account_description" class="form-control" required /></div>
								</div>
								<div class="form-group row">
									<label for="currency" class="col-sm-2 col-form-label">Currency</label>
									<div class="col-sm-4"><input type="text" id="currency" name="currency"
											class="form-control" required /></div>
									<label for="data_type" class="col-sm-2 col-form-label">Data Type</label>
									<div class="col-sm-4"><input type="text" id="data_type" name="data_type"
											class="form-control" required /></div>
								</div>
							</div>
							<div class="card-footer">
								<button type="button" class="custom-tab-btn" onclick="submitAddForm();"><i
										class="fa fa-check"></i> Submit</button>
								<button type="button" class="custom-tab-btn" onclick="list();"
									style="background-color: #6c757d;"><i class="fa fa-times"></i> Cancel</button>
							</div>
						</form>
					</div>
				</div>

				<!-- EDIT MODE -->
				<div th:if="${formmode}=='edit'" style="padding: 0 10px;">
					<div class="card my-3">
						<div class="card-header" style="background-color: #2b547e; display: flex; align-items: center;">
							<div class="left-arrow-circle" onclick="list();"><i class="fa fa-arrow-left"></i></div>
							<h5 th:text="${menu}" style="font-size: 20px; margin: 0;"></h5>
						</div>
						<form id="editForm" method="post">
							<div class="card-body" style="max-height: 600px; overflow-y: auto;">
								<!-- Form Rows -->
								<div class="form-group row">
									<label for="gl_head" class="col-sm-2 col-form-label">Gl Head</label>
									<div class="col-sm-4"><input type="text" name="gl_head" class="form-control"
											th:value="${basemappingparameter.gl_head}" required /></div>
									<label for="gl_subhead_code" class="col-sm-2 col-form-label">Gl Sub Head
										Code</label>
									<div class="col-sm-4"><input type="text" name="gl_subhead_code" class="form-control"
											th:value="${basemappingparameter.gl_subhead_code}" required /></div>
								</div>
								<div class="form-group row">
									<label for="account_id_bacid" class="col-sm-2 col-form-label">Account
										ID/Bacid</label>
									<div class="col-sm-4"><input type="text" name="account_id_bacid"
											class="form-control" th:value="${basemappingparameter.account_id_bacid}"
											readonly /></div>
									<label for="account_description" class="col-sm-2 col-form-label">Account
										Description</label>
									<div class="col-sm-4"><input type="text" name="account_description"
											class="form-control" th:value="${basemappingparameter.account_description}"
											required /></div>
								</div>
								<div class="form-group row">
									<label for="currency" class="col-sm-2 col-form-label">Currency</label>
									<div class="col-sm-4"><input type="text" name="currency" class="form-control"
											th:value="${basemappingparameter.currency}" required /></div>
									<label for="data_type" class="col-sm-2 col-form-label">Data Type</label>
									<div class="col-sm-4"><input type="text" name="data_type" class="form-control"
											th:value="${basemappingparameter.data_type}" required /></div>
								</div>
							</div>
							<div class="card-footer">
								<button type="button" class="custom-tab-btn" onclick="submitEditForm();"
									style="background-color: #2b547e;"><i class="fa fa-save"></i> Update</button>
								<button type="button" class="custom-tab-btn" onclick="list();"
									style="background-color: #6c757d;"><i class="fa fa-times"></i> Cancel</button>
							</div>
						</form>
					</div>
				</div>

				<!-- VIEW/DELETE SHARED LAYOUT -->
				<div th:if="${formmode}=='view' or ${formmode}=='delete'" style="padding: 0 10px;">
					<div class="card my-3">
						<div class="card-header"
							th:styleappend="${formmode=='delete'} ? 'background-color: #b30000;' : 'background-color: #007bff;'"
							style="display: flex; align-items: center;">
							<div class="left-arrow-circle" onclick="list();"><i class="fa fa-arrow-left"></i></div>
							<h5 th:text="${menu}" style="font-size: 20px; margin: 0;"></h5>
						</div>
						<form id="viewDeleteForm">
							<div class="card-body" style="max-height: 600px; overflow-y: auto;">
								<!-- Readonly Form Rows -->
								<div class="form-group row">
									<label class="col-sm-2 col-form-label">Gl Head</label>
									<div class="col-sm-4"><input type="text" class="form-control"
											th:value="${basemappingparameter.gl_head}" readonly /></div>
									<label class="col-sm-2 col-form-label">Gl Sub Head Code</label>
									<div class="col-sm-4"><input type="text" class="form-control"
											th:value="${basemappingparameter.gl_subhead_code}" readonly /></div>
								</div>
								<div class="form-group row">
									<label class="col-sm-2 col-form-label">Account ID/Bacid</label>
									<div class="col-sm-4"><input type="text" id="record_id_to_delete"
											class="form-control" th:value="${basemappingparameter.account_id_bacid}"
											readonly /></div>
									<label class="col-sm-2 col-form-label">Account Description</label>
									<div class="col-sm-4"><input type="text" class="form-control"
											th:value="${basemappingparameter.account_description}" readonly /></div>
								</div>
								<div class="form-group row">
									<label class="col-sm-2 col-form-label">Currency</label>
									<div class="col-sm-4"><input type="text" class="form-control"
											th:value="${basemappingparameter.currency}" readonly /></div>
									<label class="col-sm-2 col-form-label">Data Type</label>
									<div class="col-sm-4"><input type="text" class="form-control"
											th:value="${basemappingparameter.data_type}" readonly /></div>
								</div>
							</div>
							<div class="card-footer">
								<button th:if="${formmode}=='delete'" type="button" class="custom-tab-btn"
									onclick="confirmDelete();" style="background-color: #b30000;">
									<i class="fa fa-trash"></i> Delete
								</button>
								<button type="button" class="custom-tab-btn" onclick="list();">
									<i class="fa fa-arrow-left"></i> Back to List
								</button>
							</div>
						</form>
					</div>
				</div>

			</div>
		</div>
	</div>

	<!-- MODALS SECTION -->
	<!-- Alert Modal -->
	<div class="modal fade" id="alertModal" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header" id="alertModalHeader">
					<h5 class="modal-title" id="alertModalLabel">Information</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: white;">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<p id="alertMsg"></p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Delete Confirmation Modal -->
	<div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header" style="background-color: #b30000; color: white;">
					<h5 class="modal-title">Confirm Deletion</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: white;">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					Are you sure you want to permanently delete this record?
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-danger" onclick="executeDelete();">Yes, Delete</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Loader Modal -->
	<div class="modal fade" id="loaderModal" data-backdrop="static" data-keyboard="false" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered border-0">
			<div class="modal-content" style="background: transparent; border: none;">
				<div class="modal-body text-center">
					<div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
						<span class="sr-only">Loading...</span>
					</div>
				</div>
			</div>
		</div>
	</div>


	<script th:inline="javascript">
		// Global flag to handle redirection after modal closes
		let shouldRedirectToList = false;

		// Attach event listener to the alert modal
		$('#alertModal').on('hidden.bs.modal', function () {
			if (shouldRedirectToList) {
				list(); // Redirect to the list page
			}
		});

		// --- Navigation Functions ---
		function list() {window.location.href = 'BasemappingParameter?formmode=list';}
		function add_new_record() {window.location.href = 'BasemappingParameter?formmode=add';}
		function view_btn_submit(el) {window.location.href = 'BasemappingParameter?formmode=view&account_id_bacid=' + el.getAttribute("data-id");}
		function edit_btn_submit(el) {window.location.href = 'BasemappingParameter?formmode=edit&account_id_bacid=' + el.getAttribute("data-id");}
		function delete_btn_submit(el) {window.location.href = 'BasemappingParameter?formmode=delete&account_id_bacid=' + el.getAttribute("data-id");}


		// --- Form Submission Functions ---
		function submitAddForm() {
			if (!$("#addForm").valid()) return;
			const formData = new FormData(document.getElementById("addForm"));

			$.ajax({
				url: './createBaseMappingParameter',
				type: 'POST',
				data: formData,
				processData: false,
				contentType: false,
				success: function (response) {
					// On success, set the flag and show a success modal
					shouldRedirectToList = true;
					showAlert(response, 'success');
				},
				error: function (xhr) {
					// On error, show an error modal
					shouldRedirectToList = false;
					showAlert(xhr.responseText || 'An unknown error occurred.', 'error');
				}
			});
		}

		function submitEditForm() {
			if (!$("#editForm").valid()) return;
			const formData = new FormData(document.getElementById("editForm"));

			$.ajax({
				url: './updateBasemappingParameter',
				type: 'POST',
				data: formData,
				processData: false,
				contentType: false,
				success: function (response) {
					shouldRedirectToList = true;
					showAlert(response, 'success');
				},
				error: function (xhr) {
					shouldRedirectToList = false;
					showAlert(xhr.responseText || 'Error updating data.', 'error');
				}
			});
		}

		function confirmDelete() {
			// Simply shows the confirmation modal. The actual delete is handled by executeDelete.
			$('#deleteConfirmModal').modal('show');
		}

		function executeDelete() {
			$('#deleteConfirmModal').modal('hide');
			$('#loaderModal').modal('show');

			const recordId = document.getElementById("record_id_to_delete").value;

			$.ajax({
				type: 'POST',
				url: './deletebasemappingparameter?formmode=' + encodeURIComponent(recordId),
				success: function (response) {
					$('#loaderModal').modal('hide');
					shouldRedirectToList = true;
					showAlert(response, 'success');
				},
				error: function (xhr) {
					$('#loaderModal').modal('hide');
					shouldRedirectToList = false;
					showAlert(xhr.responseText || 'Error deleting record.', 'error');
				}
			});
		}

		// --- Helper Functions ---
		function showAlert(message, type) {
			const modalHeader = $('#alertModalHeader');
			const modalTitle = $('#alertModalLabel');

			if (type === 'success') {
				modalHeader.css('background-color', '#28a745'); // Green
				modalTitle.text('Success');
			} else {
				modalHeader.css('background-color', '#dc3545'); // Red
				modalTitle.text('Error');
			}

			$("#alertMsg").text(message);
			$('#alertModal').modal('show');
		}

		// Initialize DataTables and form validation on document ready
		$(document).ready(function () {
			// --- MODIFIED DATATABLES INITIALIZATION ---
			$('#usertable').DataTable({
				"lengthChange": false // Hides the "Show X entries" dropdown
			});

			$("#addForm").validate();
			$("#editForm").validate();
		});
	</script>
</body>

</html>